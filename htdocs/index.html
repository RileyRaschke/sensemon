<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Riley Raschke">
  <!--<link rel='stylesheet' href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" />-->
  <!--<link rel="stylesheet" href="css/styles.min.css">-->
  <title>Sensor Monitor</title>
</head>
<body>
<div>
  <canvas id="temperatureChartCanvas"></canvas>
  <br>
  <canvas id="humidityChartCanvas"></canvas>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>

   const temperatureChartCanvas = document.getElementById('temperatureChartCanvas');
   const humidityChartCanvas = document.getElementById('humidityChartCanvas');

   var TemperatureChart;
   var HumidityChart;
   var xAxisLabels = {};
   var SensorNames = {};
   var SensorTypes = {};
   var SensorIndex = [];
   var SensorData = [];
   var TempDataArray = []
   var HumiDataArray = []

   async function GetSensors() {
      res = await jQuery.ajax({
         type: 'GET',
         url: 'api/sensors',
         headers: {
            Accept: "application/json"
         },
         success: function(data, textStatus, xhr){
               for(i = 0; i< data.length; ++i){
                     SensorNames[data[i].deviceID] = data[i].name;
                     SensorTypes[data[i].deviceID] = data[i].type;
                     SensorIndex[data[i].deviceID] = i;
                     TempDataArray[i] = {
                           "label": data[i].name,
                           "data": [],
                           "borderWidth": 1,
                     };
                     HumiDataArray[i] = {
                           "label": data[i].name,
                           "data": [],
                           "borderWidth": 1,
                     };
               }
               SensorData = data;
         }
      });
      return res
   }

   async function GetData() {
      res = await jQuery.ajax({
         type: 'GET',
         url: 'api/allsensors/15',
         headers: {
            Accept: "application/json"
         },
         success: function(data, textStatus, xhr){
            for(i = 0; i < data.length; ++i){
                  xAxisLabels[data[i].ts] = 1
                  TempDataArray[SensorIndex[data[i].deviceID]]['data'].push(data[i].fahrenheit);
                  HumiDataArray[SensorIndex[data[i].deviceID]]['data'].push(data[i].humidity);
            }
         }
      });
      return res
   }

   function ChartTemps(){
     if( TemperatureChart ) {
       TemperatureChart.destroy();
     }
     TemperatureChart = new Chart(temperatureChartCanvas, {
       type: 'line',
       data: {
         labels: Object.keys(xAxisLabels),
         datasets: TempDataArray,
       },
       options: {
         plugins: {
           title: {
             display: true,
             text: "24H Temperature",
           },
         },
         scales: {
               y: {
                     type: 'linear',
                     display: true,
                  },
            },
       }
     });
   }

   function ChartHumid(){
     if( HumidityChart ) {
       HumidityChart.destroy();
     }
     HumidityChart = new Chart(humidityChartCanvas, {
       type: 'line',
       data: {
         labels: Object.keys(xAxisLabels),
         datasets: HumiDataArray,
       },
       options: {
         plugins: {
           title: {
             display: true,
             text: "24H Humidity",
           },
         },
         scales: {
               y: {
                     type: 'linear',
                     display: true,
                  },
            },
       }
     });
   }

   async function DrawIndexCharts(){
     ChartTemps();
     ChartHumid();
   }

$(document).ready( async function() {
  await GetSensors();
  await GetData();

  DrawIndexCharts();

  $( window ).on( "orientationchange", function( event ) {
    DrawIndexCharts();
  });

});

</script>
</body>
</html>
